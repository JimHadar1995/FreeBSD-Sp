284,286c284,287
< 		if (*(cnp->cn_nameptr) == '/') {
< 			vrele(dp);
< 			if (ndp->ni_strictrelative != 0) {
---
> 		if(!(cnp->cn_flags & ISUFSRENAME)){
> 			if (*(cnp->cn_nameptr) == '/') {
> 				vrele(dp);
> 				if (ndp->ni_strictrelative != 0) {
288,289c289,290
< 				if (KTRPOINT(curthread, KTR_CAPFAIL))
< 					ktrcapfail(CAPFAIL_LOOKUP, NULL, NULL);
---
> 					if (KTRPOINT(curthread, KTR_CAPFAIL))
> 						ktrcapfail(CAPFAIL_LOOKUP, NULL, NULL);
291,296c292,300
< 				namei_cleanup_cnp(cnp);
< 				return (ENOTCAPABLE);
< 			}
< 			while (*(cnp->cn_nameptr) == '/') {
< 				cnp->cn_nameptr++;
< 				ndp->ni_pathlen--;
---
> 					namei_cleanup_cnp(cnp);
> 					return (ENOTCAPABLE);
> 				}
> 				while (*(cnp->cn_nameptr) == '/') {
> 					cnp->cn_nameptr++;
> 					ndp->ni_pathlen--;
> 				}
> 				dp = ndp->ni_rootdir;
> 				VREF(dp);
298,299d301
< 			dp = ndp->ni_rootdir;
< 			VREF(dp);
